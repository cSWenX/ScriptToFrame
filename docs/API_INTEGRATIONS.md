# ScriptToFrame APIé›†æˆæ–‡æ¡£

## æ¦‚è¿°

ScriptToFrameé›†æˆäº†ä¸‰ä¸ªä¸»è¦çš„ç¬¬ä¸‰æ–¹APIï¼šç«å±±å¼•æ“å³æ¢¦API (å›¾ç‰‡ç”Ÿæˆ)ã€Claude API (å‰§æœ¬åˆ†æå¤‡é€‰)ã€DeepSeek API (ä¸»è¦å‰§æœ¬åˆ†æ)ã€‚æœ¬æ–‡æ¡£è¯¦ç»†è¯´æ˜äº†è¿™äº›APIçš„é›†æˆæ–¹å¼ã€é…ç½®æ–¹æ³•å’Œä½¿ç”¨æŒ‡å—ã€‚

## APIé›†æˆæ¶æ„å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      APIé›†æˆæ¶æ„                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ScriptToFrame ç³»ç»Ÿ
         â”‚
    â”Œâ”€â”€â”€â”€â”´â”€â”€â”€â”€â”
    â”‚         â”‚
    â–¼         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   å‰§æœ¬åˆ†æAPI    â”‚  â”‚   å›¾ç‰‡ç”ŸæˆAPI    â”‚  â”‚   è¾…åŠ©æœåŠ¡API    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚                    â”‚                    â”‚
    â”Œâ”€â”€â”€â”€â”´â”€â”€â”€â”€â”               â”‚               â”Œâ”€â”€â”€â”€â”´â”€â”€â”€â”€â”
    â–¼         â–¼               â–¼               â–¼         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚DeepSeekâ”‚ â”‚Claude  â”‚  â”‚ç«å±±å¼•æ“å³æ¢¦API â”‚ â”‚å¥åº·æ£€æŸ¥â”‚ â”‚æ—¥å¿—æœåŠ¡â”‚
â”‚   API  â”‚ â”‚  API   â”‚  â”‚   (ä¸»è¦)     â”‚ â”‚  API   â”‚ â”‚  API   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â”‚         â”‚               â”‚
    â–¼         â–¼               â–¼
èšåˆåˆ†æ    å¤‡é€‰åˆ†æ      ä¸“ä¸šå›¾ç‰‡ç”Ÿæˆ
4æ­¥å·¥ä½œæµ   æ™ºèƒ½åˆ†æ      16:9åˆ†é•œå›¾
```

## ç«å±±å¼•æ“å³æ¢¦APIé›†æˆ

### APIæ¦‚è¿°

**æœåŠ¡å•†**: ç«å±±å¼•æ“ (å­—èŠ‚è·³åŠ¨)
**æœåŠ¡**: å³æ¢¦AIç»˜ç”» V4.0
**ç”¨é€”**: é«˜è´¨é‡åˆ†é•œå›¾ç‰‡ç”Ÿæˆ
**ç‰¹ç‚¹**:
- æ”¯æŒä¸­æ–‡æç¤ºè¯
- 16:9æ¯”ä¾‹è¾“å‡º
- ä¸“ä¸šçº§å›¾ç‰‡è´¨é‡
- å®˜æ–¹Python SDKæ”¯æŒ

### è®¤è¯é…ç½®

**è®¤è¯æ–¹å¼**: AccessKey + SecretKey
**ç­¾åç®—æ³•**: HMAC-SHA256 (ç”±å®˜æ–¹SDKå¤„ç†)

**ç¯å¢ƒå˜é‡é…ç½®**:
```bash
# ç«å±±å¼•æ“APIå¯†é’¥ (æ”¯æŒBase64ç¼–ç )
VOLCENGINE_ACCESS_KEY_ID=your_access_key_here
VOLCENGINE_SECRET_ACCESS_KEY=your_secret_key_here

# å¯é€‰é…ç½®
VOLCENGINE_REGION=cn-north-1
VOLCENGINE_SERVICE=cv
```

**å¯†é’¥è§£ç é€»è¾‘**:
```python
def create_visual_service():
    """åˆ›å»ºå¹¶é…ç½®ç«å±±å¼•æ“è§†è§‰æœåŠ¡å®ä¾‹"""
    access_key = os.getenv('VOLCENGINE_ACCESS_KEY_ID')
    secret_key = os.getenv('VOLCENGINE_SECRET_ACCESS_KEY')

    # æ£€æŸ¥å¯†é’¥æ˜¯å¦æ˜¯Base64ç¼–ç 
    import base64
    try:
        decoded_access_key = base64.b64decode(access_key).decode('utf-8')
        decoded_secret_key = base64.b64decode(secret_key).decode('utf-8')
        print(f"ğŸ”‘ [å¯†é’¥è§£ç ] ä½¿ç”¨è§£ç åçš„å¯†é’¥")
        access_key = decoded_access_key
        secret_key = decoded_secret_key
    except:
        print(f"ğŸ”‘ [å¯†é’¥ç›´æ¥] ä½¿ç”¨åŸå§‹å¯†é’¥")

    # åˆ›å»ºæœåŠ¡å®ä¾‹
    visual_service = VisualService()
    visual_service.set_ak(access_key.strip())
    visual_service.set_sk(secret_key.strip())

    return visual_service
```

### APIè°ƒç”¨æµç¨‹

**1. ä»»åŠ¡æäº¤ (å¼‚æ­¥)**:
```python
submit_form = {
    "req_key": "jimeng_t2i_v40",  # å³æ¢¦V4æ¨¡å‹
    "prompt": "Masterpiece, top quality, anime style, young man standing on mountain peak, wind blowing, sunset lighting, 16:9 aspect ratio",
    "return_url": True,  # è¿”å›URLæ ¼å¼
    "logo_info": {
        "add_logo": False,    # ä¸æ·»åŠ æ°´å°
        "position": 0,
        "language": 0,
        "opacity": 1
    }
}

# æäº¤ä»»åŠ¡
submit_resp = visual_service.cv_sync2async_submit_task(submit_form)
print(f"æäº¤å“åº”: {submit_resp}")

# æ£€æŸ¥å“åº”çŠ¶æ€
if submit_resp.get('code') != 10000:
    raise HTTPException(
        status_code=400,
        detail=f"ä»»åŠ¡æäº¤å¤±è´¥: {submit_resp.get('message')}"
    )

# è·å–ä»»åŠ¡ID
submit_data = submit_resp.get('data', {})
task_id = submit_data.get('task_id')
```

**2. è½®è¯¢ç»“æœ**:
```python
# è½®è¯¢é…ç½®
MAX_POLL_TIMES = 150  # æœ€å¤š150æ¬¡
POLL_INTERVAL = 2     # æ¯2ç§’è½®è¯¢ä¸€æ¬¡

for i in range(MAX_POLL_TIMES):
    await asyncio.sleep(POLL_INTERVAL)

    query_form = {
        "req_key": "jimeng_t2i_v40",
        "task_id": task_id,
        "return_url": True,
        "logo_info": {
            "add_logo": False,
            "position": 0,
            "language": 0,
            "opacity": 1
        }
    }

    query_resp = visual_service.cv_sync2async_get_result(query_form)
    query_data = query_resp.get('data', {})

    # æ£€æŸ¥æ˜¯å¦æœ‰Base64æ•°æ® (å¸¸è§æƒ…å†µ)
    if query_data.get('binary_data_base64'):
        base64_data = query_data['binary_data_base64'][0]
        return f"data:image/png;base64,{base64_data}"

    # æ£€æŸ¥æ˜¯å¦æœ‰å›¾ç‰‡URL
    if query_data.get('image_urls'):
        image_url = query_data['image_urls'][0]
        return image_url

    # æ£€æŸ¥ä»»åŠ¡çŠ¶æ€
    status = query_data.get('status')
    if status == 2 or status == -1 or status == "failed":
        raise HTTPException(status_code=500, detail="ä»»åŠ¡æ‰§è¡Œå¤±è´¥")

# è¶…æ—¶å¤„ç†
raise HTTPException(status_code=408, detail="å›¾ç‰‡ç”Ÿæˆè¶…æ—¶")
```

### æç¤ºè¯ä¼˜åŒ–

**æç¤ºè¯ç»“æ„**:
```
è´¨é‡å‰ç¼€ + é£æ ¼æè¿° + ä¸»ä½“å†…å®¹ + ç¯å¢ƒæè¿° + æŠ€æœ¯å‚æ•°

ç¤ºä¾‹:
"Masterpiece, top quality, highly detailed, 8k resolution,
anime style,
young man with black hair wearing blue coat standing on mountain peak,
dramatic sunset lighting, cinematic composition,
--ar 16:9"
```

**è´¨é‡ä¿®é¥°è¯åº“**:
```python
QUALITY_PREFIXES = [
    "Masterpiece, top quality, highly detailed",
    "Professional artwork, ultra-detailed",
    "High quality illustration, 8k resolution",
    "Premium digital art, photorealistic"
]

STYLE_MODIFIERS = {
    "anime": "anime style, manga illustration",
    "realistic": "photorealistic, hyperrealistic",
    "manga": "manga style, comic book illustration",
    "3d": "3D rendered, digital art"
}

LIGHTING_EFFECTS = [
    "cinematic lighting",
    "dramatic lighting",
    "soft natural lighting",
    "sunset lighting",
    "studio lighting"
]
```

**åŠ¨æ€æç¤ºè¯ç”Ÿæˆ**:
```python
def build_optimized_prompt(base_description: str, style: str = "anime", quality: str = "high"):
    """æ„å»ºä¼˜åŒ–çš„å³æ¢¦æç¤ºè¯"""

    # è´¨é‡å‰ç¼€
    quality_prefix = QUALITY_PREFIXES[0] if quality == "high" else "Good quality"

    # é£æ ¼ä¿®é¥°
    style_modifier = STYLE_MODIFIERS.get(style, "anime style")

    # æŠ€æœ¯å‚æ•°
    technical_params = "16:9 aspect ratio, cinematic composition"

    # ç»„åˆæç¤ºè¯
    optimized_prompt = f"{quality_prefix}, {style_modifier}, {base_description}, {technical_params}"

    # é•¿åº¦æ£€æŸ¥ (å³æ¢¦APIé€šå¸¸é™åˆ¶åœ¨1000å­—ç¬¦ä»¥å†…)
    if len(optimized_prompt) > 1000:
        # æˆªæ–­å¹¶ä¿ç•™é‡è¦éƒ¨åˆ†
        optimized_prompt = optimized_prompt[:900] + "..."

    return optimized_prompt

# ä½¿ç”¨ç¤ºä¾‹
prompt = build_optimized_prompt(
    "young man standing on mountain peak with sword",
    style="anime",
    quality="high"
)
```

### é”™è¯¯å¤„ç†

**å¸¸è§é”™è¯¯ç å’Œå¤„ç†**:
```python
VOLCENGINE_ERROR_CODES = {
    10000: "æˆåŠŸ",
    10001: "å‚æ•°é”™è¯¯",
    10002: "é‰´æƒå¤±è´¥",
    10003: "è¯·æ±‚é¢‘ç‡é™åˆ¶",
    10004: "ä½™é¢ä¸è¶³",
    10005: "å†…å®¹å®¡æ ¸å¤±è´¥",
    20001: "æœåŠ¡å†…éƒ¨é”™è¯¯",
    20002: "ä»»åŠ¡é˜Ÿåˆ—æ»¡",
    30001: "ä»»åŠ¡ä¸å­˜åœ¨",
    30002: "ä»»åŠ¡å·²è¿‡æœŸ"
}

def handle_volcengine_error(error_code: int, error_message: str):
    """å¤„ç†ç«å±±å¼•æ“APIé”™è¯¯"""
    error_description = VOLCENGINE_ERROR_CODES.get(error_code, "æœªçŸ¥é”™è¯¯")

    if error_code == 10002:
        raise ConfigurationError(f"APIå¯†é’¥é…ç½®é”™è¯¯: {error_message}")
    elif error_code == 10003:
        raise APIRateLimitError(f"è¯·æ±‚é¢‘ç‡è¿‡é«˜ï¼Œè¯·ç¨åé‡è¯•: {error_message}")
    elif error_code == 10004:
        raise InsufficientBalanceError(f"è´¦æˆ·ä½™é¢ä¸è¶³: {error_message}")
    elif error_code == 10005:
        raise ContentModerationError(f"å†…å®¹å®¡æ ¸å¤±è´¥ï¼Œè¯·æ£€æŸ¥æç¤ºè¯: {error_message}")
    elif error_code in [20001, 20002]:
        raise ServiceUnavailableError(f"æœåŠ¡æš‚æ—¶ä¸å¯ç”¨: {error_message}")
    elif error_code in [30001, 30002]:
        raise TaskExpiredError(f"ä»»åŠ¡å·²è¿‡æœŸæˆ–ä¸å­˜åœ¨: {error_message}")
    else:
        raise VolcengineAPIError(f"APIè°ƒç”¨å¤±è´¥ ({error_code}): {error_message}")
```

## DeepSeek APIé›†æˆ

### APIæ¦‚è¿°

**æœåŠ¡å•†**: DeepSeek
**æœåŠ¡**: DeepSeek Chat API
**ç”¨é€”**: ä¸»è¦å‰§æœ¬åˆ†ææœåŠ¡
**æ¨¡å‹**: deepseek-chat
**ç‰¹ç‚¹**:
- ä¸­æ–‡ç†è§£èƒ½åŠ›å¼º
- æˆæœ¬ç›¸å¯¹è¾ƒä½
- ç¨³å®šæ€§å¥½
- æ”¯æŒé•¿æ–‡æœ¬å¤„ç†

### è®¤è¯é…ç½®

**è®¤è¯æ–¹å¼**: Bearer Token
**APIæ ¼å¼**: OpenAIå…¼å®¹æ ¼å¼

**ç¯å¢ƒå˜é‡é…ç½®**:
```bash
# DeepSeek APIé…ç½®
DEEPSEEK_API_KEY=your_deepseek_api_key_here
DEEPSEEK_BASE_URL=https://api.deepseek.com/v1

# å¯é€‰é…ç½®
DEEPSEEK_MODEL=deepseek-chat
DEEPSEEK_MAX_TOKENS=4000
DEEPSEEK_TEMPERATURE=0.7
```

### APIè°ƒç”¨å®ç°

**åŸºç¡€è°ƒç”¨å‡½æ•°**:
```javascript
async function callDeepSeek(prompt, stepName, requestId) {
  const requestData = {
    model: 'deepseek-chat',
    messages: [
      {
        role: 'user',
        content: prompt
      }
    ],
    max_tokens: 4000,
    temperature: 0.7
  };

  console.log(`ğŸ¤– [æ™ºèƒ½åˆ†æ-${requestId}] æ‰§è¡Œ${stepName}...`);

  // åˆ›å»ºAbortControllerç”¨äºè¶…æ—¶æ§åˆ¶
  const controller = new AbortController();
  const timeoutId = setTimeout(() => {
    console.warn(`â° [æ™ºèƒ½åˆ†æ-${requestId}] ${stepName}è¶…æ—¶ï¼Œä¸­æ–­è¯·æ±‚ (60ç§’)`);
    controller.abort();
  }, 60000);

  try {
    const startTime = Date.now();
    const response = await fetch(process.env.DEEPSEEK_BASE_URL + '/chat/completions', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${process.env.DEEPSEEK_API_KEY}`
      },
      body: JSON.stringify(requestData),
      signal: controller.signal
    });

    clearTimeout(timeoutId);
    const responseTime = Date.now() - startTime;

    console.log(`ğŸ“¥ [æ™ºèƒ½åˆ†æ-${requestId}] DeepSeekå“åº”:`, {
      status: response.status,
      responseTime: `${responseTime}ms`,
      stepName: stepName
    });

    if (!response.ok) {
      const errorText = await response.text();
      throw new Error(`${stepName}å¤±è´¥: HTTP ${response.status} - ${errorText}`);
    }

    const result = await response.json();

    if (!result.choices || !result.choices[0] || !result.choices[0].message) {
      throw new Error(`${stepName}å¤±è´¥: APIè¿”å›æ ¼å¼é”™è¯¯`);
    }

    const content = result.choices[0].message.content;
    console.log(`âœ… [æ™ºèƒ½åˆ†æ-${requestId}] ${stepName}æˆåŠŸï¼Œå†…å®¹é•¿åº¦: ${content.length}`);

    return content;

  } catch (error) {
    clearTimeout(timeoutId);

    if (error.name === 'AbortError') {
      throw new Error(`${stepName}å¤±è´¥: è¯·æ±‚è¶…æ—¶ï¼ˆ60ç§’ï¼‰`);
    } else if (error.message.includes('fetch')) {
      throw new Error(`${stepName}å¤±è´¥: ç½‘ç»œè¿æ¥é”™è¯¯`);
    } else {
      throw new Error(`${stepName}å¤±è´¥: ${error.message}`);
    }
  }
}
```

### åˆ†æ­¥æç¤ºè¯æ¨¡æ¿

**Step1: æ•…äº‹åˆ‡åˆ†æ¨¡æ¿**:
```javascript
const STEP1_PROMPT_TEMPLATE = `# Role: èµ„æ·±ç¼–è¾‘ä¸åˆ†é•œå¸ˆ

# Task:
è¯·é˜…è¯»æˆ‘æä¾›çš„ã€æ•…äº‹æ–‡æœ¬ã€‘ï¼Œå¹¶å°†å…¶åˆ‡åˆ†ä¸ºã€Target_Numberã€‘ä¸ªéƒ¨åˆ†ã€‚
åˆ‡åˆ†åçš„æ¯ä¸€éƒ¨åˆ†å°†ç”¨äºç”Ÿæˆå•å¼ å…³é”®åˆ†é•œï¼Œå› æ­¤éœ€è¦ä¿è¯æ¯ä¸€æ®µçš„æ–‡å­—é‡é€‚ä¸­ï¼Œä¸”åŒ…å«æ˜ç¡®çš„ç”»é¢ä¿¡æ¯ã€‚

# Inputs:
1. æ•…äº‹æ–‡æœ¬: {SCRIPT_CONTENT}
2. åˆ‡åˆ†ä»½æ•° (Target_Number): {SCENE_COUNT}

# Important Rules:
1. å¿…é¡»ä¸¥æ ¼æŒ‰ç…§è¦æ±‚çš„ä»½æ•°è¿›è¡Œåˆ‡åˆ†ï¼Œç¡®ä¿ç”Ÿæˆ**å‡†ç¡®çš„{SCENE_COUNT}ä»½**å†…å®¹
2. ä¿æŒæ•…äº‹åŸæ±åŸå‘³ï¼Œä¸è¦åˆ å‡ç»†èŠ‚ï¼Œåªæ˜¯è¿›è¡Œç‰©ç†åˆ‡åˆ†
3. ç¡®ä¿åˆ‡åˆ†ç‚¹è½åœ¨æƒ…èŠ‚è½¬æŠ˜æˆ–åŠ¨ä½œå˜æ¢çš„è‡ªç„¶åœé¡¿å¤„
4. æ¯ä¸€ä»½éƒ½å¿…é¡»åŒ…å«å®Œæ•´çš„ç”»é¢ä¿¡æ¯ï¼Œé€‚åˆç”Ÿæˆåˆ†é•œå›¾
5. å¦‚æœæ•…äº‹è¾ƒçŸ­ï¼Œå¯ä»¥æŒ‰ç…§æ—¶é—´é¡ºåºã€åœ°ç‚¹å˜åŒ–ã€äººç‰©åŠ¨ä½œç­‰è¿›è¡Œåˆç†åˆ‡åˆ†

# Output Format:
è¯·ä¸¥æ ¼æŒ‰ç…§ä»¥ä¸‹æ ¼å¼è¾“å‡ºæ¯ä¸€ä»½ï¼Œç¡®ä¿è¾“å‡º{SCENE_COUNT}ä»½ï¼š

---
## ç¬¬1ä»½
**å®Œæ•´å‰§æƒ…åŸæ–‡**: [è¿™é‡Œå¿…é¡»æ”¾å…¥åˆ‡åˆ†å‡ºæ¥çš„åŸå§‹æ•…äº‹æ–‡æœ¬ï¼Œä¸è¦æ¦‚æ‹¬]
**æ ¸å¿ƒè§†è§‰ç‚¹**: [ç”¨ä¸€å¥è¯æç‚¼è¿™æ®µæ–‡å­—æœ€æ ¸å¿ƒçš„ç”»é¢å†…å®¹]
---
## ç¬¬2ä»½
**å®Œæ•´å‰§æƒ…åŸæ–‡**: [è¿™é‡Œå¿…é¡»æ”¾å…¥åˆ‡åˆ†å‡ºæ¥çš„åŸå§‹æ•…äº‹æ–‡æœ¬ï¼Œä¸è¦æ¦‚æ‹¬]
**æ ¸å¿ƒè§†è§‰ç‚¹**: [ç”¨ä¸€å¥è¯æç‚¼è¿™æ®µæ–‡å­—æœ€æ ¸å¿ƒçš„ç”»é¢å†…å®¹]
---
[ç»§ç»­è¾“å‡ºåˆ°ç¬¬{SCENE_COUNT}ä»½]

è®°ä½ï¼šå¿…é¡»è¾“å‡ºå‡†ç¡®çš„{SCENE_COUNT}ä»½å†…å®¹ï¼`;
```

**Step2: å…³é”®å¸§æå–æ¨¡æ¿**:
```javascript
const STEP2_PROMPT_TEMPLATE = `# Role: è§†è§‰å¯¼æ¼”

# Task:
åŸºäºä¸Šä¸€æ­¥åˆ‡åˆ†çš„æ¯ä¸€ä»½ã€å®Œæ•´å‰§æƒ…åŸæ–‡ã€‘ï¼Œå°†å…¶è½¬åŒ–ä¸ºå…·ä½“çš„ç”»é¢è§†è§‰æè¿°ã€‚

# Logic Rules (å…³é”®):
1. å¯¹äº **ç¬¬1ä»½ åˆ° ç¬¬{LAST_SCENE_INDEX}ä»½**ï¼š
   - åªæç‚¼ **1ä¸ª"å¼€å§‹å¸§"**ã€‚è¿™ä¸ªç”»é¢ä»£è¡¨è¯¥æ®µå‰§æƒ…å¼€å§‹æ—¶çš„çŠ¶æ€ã€‚
2. å¯¹äº **æœ€åä¸€ä»½ (ç¬¬{SCENE_COUNT}ä»½)**ï¼š
   - æç‚¼ **1ä¸ª"å¼€å§‹å¸§"**ã€‚
   - é¢å¤–æç‚¼ **1ä¸ª"ç»“æŸå¸§"**ï¼ˆä½œä¸ºæ•´ä¸ªæ•…äº‹çš„è½å¹…/ç»“å±€ï¼‰ã€‚

# Requirement:
æè¿°å¿…é¡»åŒ…å«ï¼š
- **ä¸»ä½“**: è§’è‰²æ˜¯è°ï¼Œåœ¨åšä»€ä¹ˆåŠ¨ä½œã€‚
- **ç¯å¢ƒ**: èƒŒæ™¯ç»†èŠ‚ï¼Œå¤©æ°”ï¼Œæ—¶é—´ã€‚
- **æ°›å›´**: å…‰å½±é¢œè‰²ï¼Œæƒ…ç»ªåŸºè°ƒã€‚

# Input (ä¸Šä¸€æ­¥çš„åˆ‡åˆ†ç»“æœ):
{SEGMENTED_STORY}

# Output Format:
---
## ç¬¬Xä»½
**å¸§ç±»å‹**: [å¼€å§‹å¸§ / ç»“æŸå¸§]
**ç”»é¢æè¿°**: (ä¾‹å¦‚ï¼šæš´é›¨å¤œï¼Œæ—é»˜ç«™åœ¨éœ“è™¹é—ªçƒçš„å··å£ï¼Œé£è¡£è¢«é£å¹èµ·ï¼Œå³æ‰‹æŒ‰åœ¨åˆ€æŸ„ä¸Šï¼Œçœ¼ç¥å†·å†½)
---`;
```

**Step3: æç¤ºè¯ç”Ÿæˆæ¨¡æ¿**:
```javascript
const STEP3_PROMPT_TEMPLATE = `# Role: AIç»˜å›¾æç¤ºè¯ä¸“å®¶ (å³æ¢¦/Jimeng ä¸“é¡¹ä¼˜åŒ–)

# Setup (è§’è‰²ä¸€è‡´æ€§):
åœ¨ç”Ÿæˆæç¤ºè¯ä¹‹å‰ï¼Œè¯·å…ˆå¸®æˆ‘å»ºç«‹ä¸»è¦è§’è‰²çš„ã€ç‰¹å¾è¯åº“ã€‘ã€‚
å¯¹äºæ•…äº‹ä¸­çš„ä¸»è§’ï¼Œè¯·å›ºå®šä»¥ä¸‹æ ¼å¼ï¼š
- [è§’è‰²å]: (å…·ä½“çš„å‘å‹, å‘è‰², ç³è‰², æœè£…ç»†èŠ‚, ç‰¹æ®Šé…é¥°)
*è¯·ç¡®ä¿åœ¨æ¯ä¸€æ¡åŒ…å«è¯¥è§’è‰²çš„æç¤ºè¯ä¸­ï¼Œéƒ½å®Œæ•´åŒ…å«è¿™äº›ç‰¹å¾è¯ã€‚*

# Style & Quality (ç”»é£è®¾ç½®):
æ¯ä¸€æ¡æç¤ºè¯å¿…é¡»åŒ…å«ä»¥ä¸‹å‰ç¼€ï¼š
(Masterpiece, top quality, highly detailed, 8k resolution, cinematic lighting, dynamic composition) + {STYLE_SETTING}

# Task:
å°†ç¬¬äºŒæ­¥å¾—åˆ°çš„æ¯ä¸€ä¸ª"ç”»é¢æè¿°"è½¬åŒ–ä¸ºå³æ¢¦å¯ç”¨çš„æç¤ºè¯ã€‚

# Input (ä¸Šä¸€æ­¥çš„å…³é”®å¸§ç»“æœ):
{EXTRACTED_FRAMES}

# Output Format:
è¯·ä¸¥æ ¼æŒ‰ä»¥ä¸‹æ ¼å¼è¾“å‡ºï¼š

---
### [åºå·] ç¬¬Xä»½-[å¸§ç±»å‹]
**ä¸­æ–‡è¾…åŠ©æè¿°**: [ç®€çŸ­çš„ä¸­æ–‡ç”»é¢è¯´æ˜ï¼Œæ–¹ä¾¿æˆ‘ç¡®è®¤]
**Jimeng Prompt**: [ç”»é£ä¿®é¥°è¯], [è§’è‰²ç‰¹å¾è¯], [åŠ¨ä½œä¸å…·ä½“åœºæ™¯æè¿°], [ç¯å¢ƒä¸å…‰å½±], [é•œå¤´è¯­è¨€: å¦‚ close-up, wide angle, depth of field] --ar 16:9
---`;
```

### å“åº”è§£æ

**Step3ç»“æœè§£æå‡½æ•°**:
```javascript
function parseStep3Results(claudeResponse) {
  console.log('ğŸ” è§£æç¬¬3æ­¥ç»“æœï¼Œå†…å®¹é•¿åº¦:', claudeResponse.length);

  const frames = [];
  const sections = claudeResponse.split('---').filter(section => section.trim());

  sections.forEach((section, index) => {
    const trimmedSection = section.trim();

    // ä½¿ç”¨çµæ´»çš„æ­£åˆ™è¡¨è¾¾å¼åŒ¹é…
    const chineseMatch = trimmedSection.match(/\*\*ä¸­æ–‡è¾…åŠ©æè¿°\*\*[:ï¼š]\s*([^\n]+)/);
    const promptMatch = trimmedSection.match(/\*\*Jimeng Prompt\*\*[:ï¼š]\s*([^\n]+)/);
    const titleMatch = trimmedSection.match(/###\s*\[?\d*\]?\s*ç¬¬(\d+)ä»½[-â€”]?(å¼€å§‹å¸§|ç»“æŸå¸§)/);

    if (chineseMatch && promptMatch) {
      const sceneIndex = titleMatch ? parseInt(titleMatch[1]) : index + 1;
      const frameType = titleMatch ? titleMatch[2] : 'å¼€å§‹å¸§';

      const frame = {
        sequence: index + 1,
        sceneIndex: sceneIndex,
        frameType: frameType,
        chineseDescription: chineseMatch[1].trim(),
        jimengPrompt: promptMatch[1].trim(),
        imageUrl: null,
        isGenerating: false,
        error: null
      };

      frames.push(frame);

      console.log('âœ… æˆåŠŸè§£æå¸§:', {
        sequence: frame.sequence,
        frameType: frame.frameType,
        descLength: frame.chineseDescription.length,
        promptLength: frame.jimengPrompt.length
      });
    }
  });

  console.log(`ğŸ¯ æœ€ç»ˆè§£æç»“æœ: å…±${frames.length}ä¸ªæœ‰æ•ˆå¸§`);
  return frames;
}
```

### é”™è¯¯å¤„ç†å’Œé‡è¯•

**DeepSeek APIé”™è¯¯å¤„ç†**:
```javascript
const DEEPSEEK_ERROR_CODES = {
  400: "è¯·æ±‚å‚æ•°é”™è¯¯",
  401: "APIå¯†é’¥æ— æ•ˆ",
  403: "è®¿é—®è¢«ç¦æ­¢",
  429: "è¯·æ±‚é¢‘ç‡è¿‡é«˜",
  500: "æœåŠ¡å™¨å†…éƒ¨é”™è¯¯",
  502: "ç½‘å…³é”™è¯¯",
  503: "æœåŠ¡æš‚æ—¶ä¸å¯ç”¨"
};

function handleDeepSeekError(response, stepName) {
  const errorCode = response.status;
  const errorDescription = DEEPSEEK_ERROR_CODES[errorCode] || "æœªçŸ¥é”™è¯¯";

  let userFriendlyMessage;
  let shouldRetry = false;

  switch (errorCode) {
    case 401:
      userFriendlyMessage = "APIå¯†é’¥é…ç½®é”™è¯¯ï¼Œè¯·æ£€æŸ¥DEEPSEEK_API_KEY";
      break;
    case 429:
      userFriendlyMessage = "è¯·æ±‚è¿‡äºé¢‘ç¹ï¼Œè¯·ç¨åé‡è¯•";
      shouldRetry = true;
      break;
    case 500:
    case 502:
    case 503:
      userFriendlyMessage = "DeepSeekæœåŠ¡æš‚æ—¶ä¸å¯ç”¨ï¼Œè¯·ç¨åé‡è¯•";
      shouldRetry = true;
      break;
    default:
      userFriendlyMessage = `${stepName}å¤±è´¥: ${errorDescription}`;
  }

  const error = new Error(userFriendlyMessage);
  error.shouldRetry = shouldRetry;
  error.originalStatus = errorCode;

  throw error;
}
```

## Claude APIé›†æˆ (å¤‡é€‰)

### APIæ¦‚è¿°

**æœåŠ¡å•†**: Anthropic
**æœåŠ¡**: Claude API
**ç”¨é€”**: å¤‡é€‰å‰§æœ¬åˆ†ææœåŠ¡
**æ¨¡å‹**: claude-3-sonnet-20240229
**ç‰¹ç‚¹**:
- å¼ºå¤§çš„æ¨ç†èƒ½åŠ›
- æ”¯æŒé•¿æ–‡æœ¬
- è¾“å‡ºè´¨é‡é«˜
- æ”¯æŒä»£ç†è®¿é—®

### è®¤è¯é…ç½®

**ç¯å¢ƒå˜é‡é…ç½®**:
```bash
# Claude APIé…ç½®
ANTHROPIC_API_KEY=your_claude_api_key_here
ANTHROPIC_BASE_URL=https://anyrouter.top/v1

# å¯é€‰é…ç½®
ANTHROPIC_MODEL=claude-3-sonnet-20240229
ANTHROPIC_MAX_TOKENS=4000
ANTHROPIC_TEMPERATURE=0.7
```

### ä»£ç†é…ç½®

**SSLè¯ä¹¦å¿½ç•¥é…ç½®**:
```javascript
// lib/claude-api.js
const config = {
  apiKey: process.env.ANTHROPIC_API_KEY,
  timeout: 60000,
};

// å¦‚æœæœ‰ä»£ç†åœ°å€ï¼Œåˆ™ä½¿ç”¨ä»£ç†
if (process.env.ANTHROPIC_BASE_URL) {
  let baseUrl = process.env.ANTHROPIC_BASE_URL;

  // ç¡®ä¿ä»£ç†åœ°å€ä¸ä»¥/v1ç»“å°¾
  if (baseUrl.endsWith('/v1')) {
    baseUrl = baseUrl.slice(0, -3);
  }

  config.baseURL = baseUrl;

  // æ·»åŠ è‡ªå®šä¹‰fetchä»¥å¤„ç†SSLé—®é¢˜
  config.fetch = async (url, options) => {
    console.log('ğŸ“¡ å‘èµ·ä»£ç†è¯·æ±‚:', {
      url: url,
      method: options.method,
      hasAuth: !!options.headers?.Authorization
    });

    // å¼ºåˆ¶å¿½ç•¥SSLè¯ä¹¦éªŒè¯
    process.env["NODE_TLS_REJECT_UNAUTHORIZED"] = "0";

    // ç¡®ä¿è®¤è¯å¤´æ­£ç¡®è®¾ç½®
    const headers = {
      ...options.headers,
      'User-Agent': 'ScriptToFrame/1.0.0',
      'anthropic-version': '2023-06-01'
    };

    if (config.apiKey && !headers.Authorization) {
      headers.Authorization = `Bearer ${config.apiKey}`;
    }

    const fetchOptions = {
      ...options,
      headers: headers,
      agent: false,
    };

    const response = await fetch(url, fetchOptions);

    if (!response.ok) {
      const errorText = await response.text();
      console.log('âŒ ä»£ç†å“åº”é”™è¯¯:', errorText.substring(0, 500));
    }

    return response;
  };
}

const anthropic = new Anthropic(config);
```

**APIè°ƒç”¨ç¤ºä¾‹**:
```javascript
class ClaudeScriptParser {
  async parseScript(script, frameCount, style = 'default', genre = 'general') {
    const prompt = `
ä½ æ˜¯ä¸“ä¸šçš„æ¼«å‰§åˆ†é•œå¸ˆï¼Œè¯·æ™ºèƒ½è§£æä»¥ä¸‹å‰§æœ¬å†…å®¹å¹¶è§„åˆ’åˆ†é•œæ–¹æ¡ˆã€‚

å‰§æœ¬å†…å®¹ï¼š
${script}

è¦æ±‚ï¼š
1. æ™ºèƒ½è¯†åˆ«å‰§æœ¬æ ¼å¼
2. è‡ªåŠ¨æå–è§’è‰²ã€å¯¹è¯ã€åŠ¨ä½œã€åœºæ™¯ä¿¡æ¯
3. ç”Ÿæˆ ${frameCount} ä¸ªå…³é”®å¸§
4. ç”»é£ï¼š${style}
5. é¢˜æç±»å‹ï¼š${genre}
6. è¾“å‡ºæ¯”ä¾‹ï¼š16:9

è¯·æŒ‰ç…§ä»¥ä¸‹JSONæ ¼å¼è¾“å‡ºï¼š
{
  "script_analysis": {
    "characters": [...],
    "scenes": [...],
    "genre_detected": "...",
    "total_frames": ${frameCount}
  },
  "storyboard_frames": [
    {
      "sequence": 1,
      "scene": "åœºæ™¯åç§°",
      "characters": ["è§’è‰²"],
      "description": "è¯¦ç»†ç”»é¢æè¿°",
      "prompt": "ç”¨äºAIç»˜å›¾çš„è‹±æ–‡æç¤ºè¯",
      "emotion": "æƒ…ç»ªæ°›å›´",
      "camera_angle": "é•œå¤´è§’åº¦"
    }
  ]
}
`;

    try {
      const response = await this.anthropic.messages.create({
        model: 'claude-3-sonnet-20240229',
        max_tokens: 4000,
        messages: [
          {
            role: 'user',
            content: prompt
          }
        ]
      });

      const content = response.content[0].text;

      // JSONè§£æ
      let parsedResult;
      try {
        parsedResult = JSON.parse(content);
      } catch (jsonError) {
        // å¦‚æœè§£æå¤±è´¥ï¼Œå°è¯•æå–JSONéƒ¨åˆ†
        const jsonMatch = content.match(/\{[\s\S]*\}/);
        if (jsonMatch) {
          parsedResult = JSON.parse(jsonMatch[0]);
        } else {
          throw new Error('Claudeè¿”å›çš„å†…å®¹æ— æ³•è§£æä¸ºJSON');
        }
      }

      return {
        success: true,
        data: parsedResult
      };

    } catch (error) {
      console.error('Claude APIè°ƒç”¨å¤±è´¥:', error);
      return {
        success: false,
        error: error.message || 'å‰§æœ¬è§£æå¤±è´¥'
      };
    }
  }
}
```

## APIå®‰å…¨å’Œæœ€ä½³å®è·µ

### å¯†é’¥ç®¡ç†

**ç¯å¢ƒå˜é‡æœ€ä½³å®è·µ**:
```bash
# .env.example - æ¨¡æ¿æ–‡ä»¶ï¼Œä¸åŒ…å«çœŸå®å¯†é’¥
VOLCENGINE_ACCESS_KEY_ID=your_volcengine_access_key_here
VOLCENGINE_SECRET_ACCESS_KEY=your_volcengine_secret_key_here
DEEPSEEK_API_KEY=your_deepseek_api_key_here
ANTHROPIC_API_KEY=your_claude_api_key_here

# .env.local - å®é™…ä½¿ç”¨ï¼Œåº”åŠ å…¥.gitignore
VOLCENGINE_ACCESS_KEY_ID=your_access_key_here
VOLCENGINE_SECRET_ACCESS_KEY=your_secret_key_here
DEEPSEEK_API_KEY=your_deepseek_api_key_here
ANTHROPIC_API_KEY=your_claude_api_key_here
```

**å¯†é’¥éªŒè¯å‡½æ•°**:
```javascript
function validateApiKeys() {
  const requiredKeys = [
    'VOLCENGINE_ACCESS_KEY_ID',
    'VOLCENGINE_SECRET_ACCESS_KEY',
    'DEEPSEEK_API_KEY'
  ];

  const missingKeys = requiredKeys.filter(key => !process.env[key]);

  if (missingKeys.length > 0) {
    throw new Error(`Missing required environment variables: ${missingKeys.join(', ')}`);
  }

  // éªŒè¯å¯†é’¥æ ¼å¼
  if (!process.env.DEEPSEEK_API_KEY.startsWith('sk-')) {
    throw new Error('DEEPSEEK_API_KEY format is invalid');
  }

  console.log('âœ… APIå¯†é’¥éªŒè¯é€šè¿‡');
}

// åº”ç”¨å¯åŠ¨æ—¶éªŒè¯
validateApiKeys();
```

### è¯·æ±‚é¢‘ç‡é™åˆ¶

**é¢‘ç‡æ§åˆ¶å®ç°**:
```javascript
class RateLimiter {
  constructor(maxRequests = 10, timeWindow = 60000) {
    this.maxRequests = maxRequests;
    this.timeWindow = timeWindow;
    this.requests = new Map();
  }

  async checkLimit(apiName) {
    const now = Date.now();
    const windowStart = now - this.timeWindow;

    // è·å–å½“å‰æ—¶é—´çª—å£å†…çš„è¯·æ±‚
    if (!this.requests.has(apiName)) {
      this.requests.set(apiName, []);
    }

    const apiRequests = this.requests.get(apiName);

    // ç§»é™¤è¿‡æœŸè¯·æ±‚
    const validRequests = apiRequests.filter(time => time > windowStart);
    this.requests.set(apiName, validRequests);

    // æ£€æŸ¥æ˜¯å¦è¶…è¿‡é™åˆ¶
    if (validRequests.length >= this.maxRequests) {
      const oldestRequest = Math.min(...validRequests);
      const waitTime = oldestRequest + this.timeWindow - now;
      throw new Error(`Rate limit exceeded. Please wait ${Math.ceil(waitTime / 1000)} seconds.`);
    }

    // è®°å½•å½“å‰è¯·æ±‚
    validRequests.push(now);
  }
}

// ä¸ºä¸åŒAPIè®¾ç½®ä¸åŒçš„é™åˆ¶
const rateLimiters = {
  deepseek: new RateLimiter(20, 60000),    // 20 requests per minute
  volcengine: new RateLimiter(10, 60000),  // 10 requests per minute
  claude: new RateLimiter(5, 60000)        // 5 requests per minute
};

// ä½¿ç”¨ç¤ºä¾‹
async function callAPIWithRateLimit(apiName, apiFunction) {
  await rateLimiters[apiName].checkLimit(apiName);
  return await apiFunction();
}
```

### é”™è¯¯é‡è¯•ç­–ç•¥

**ç»Ÿä¸€é‡è¯•æœºåˆ¶**:
```javascript
class RetryableError extends Error {
  constructor(message, isRetryable = true) {
    super(message);
    this.isRetryable = isRetryable;
  }
}

async function withRetry(fn, options = {}) {
  const {
    maxRetries = 3,
    baseDelay = 1000,
    maxDelay = 10000,
    backoffFactor = 2,
    retryCondition = (error) => error.isRetryable !== false
  } = options;

  let lastError;

  for (let attempt = 0; attempt <= maxRetries; attempt++) {
    try {
      return await fn();
    } catch (error) {
      lastError = error;

      // ä¸é‡è¯•çš„é”™è¯¯ç±»å‹
      if (!retryCondition(error) || attempt === maxRetries) {
        break;
      }

      // è®¡ç®—å»¶è¿Ÿæ—¶é—´ (æŒ‡æ•°é€€é¿)
      const delay = Math.min(
        baseDelay * Math.pow(backoffFactor, attempt),
        maxDelay
      );

      console.warn(`Attempt ${attempt + 1} failed, retrying in ${delay}ms...`, {
        error: error.message,
        nextDelay: delay
      });

      await new Promise(resolve => setTimeout(resolve, delay));
    }
  }

  throw lastError;
}

// ä½¿ç”¨ç¤ºä¾‹
const result = await withRetry(
  () => callDeepSeek(prompt, stepName, requestId),
  {
    maxRetries: 2,
    baseDelay: 2000,
    retryCondition: (error) => {
      // åªé‡è¯•ç½‘ç»œé”™è¯¯å’Œ5xxé”™è¯¯
      return error.message.includes('ç½‘ç»œ') ||
             error.message.includes('503') ||
             error.message.includes('502');
    }
  }
);
```

### ç›‘æ§å’Œæ—¥å¿—

**APIè°ƒç”¨ç›‘æ§**:
```javascript
class APIMonitor {
  constructor() {
    this.metrics = {
      deepseek: { calls: 0, errors: 0, totalTime: 0 },
      volcengine: { calls: 0, errors: 0, totalTime: 0 },
      claude: { calls: 0, errors: 0, totalTime: 0 }
    };
  }

  async trackAPICall(apiName, fn) {
    const startTime = Date.now();
    this.metrics[apiName].calls++;

    try {
      const result = await fn();
      this.metrics[apiName].totalTime += Date.now() - startTime;
      return result;
    } catch (error) {
      this.metrics[apiName].errors++;
      this.metrics[apiName].totalTime += Date.now() - startTime;

      // è®°å½•é”™è¯¯è¯¦æƒ…
      console.error(`APIè°ƒç”¨å¤±è´¥ [${apiName}]:`, {
        error: error.message,
        duration: Date.now() - startTime,
        timestamp: new Date().toISOString()
      });

      throw error;
    }
  }

  getStats() {
    const stats = {};

    for (const [api, metrics] of Object.entries(this.metrics)) {
      const avgResponseTime = metrics.calls > 0
        ? Math.round(metrics.totalTime / metrics.calls)
        : 0;

      stats[api] = {
        totalCalls: metrics.calls,
        errors: metrics.errors,
        successRate: metrics.calls > 0
          ? Math.round(((metrics.calls - metrics.errors) / metrics.calls) * 100)
          : 0,
        avgResponseTime: avgResponseTime
      };
    }

    return stats;
  }
}

// å…¨å±€ç›‘æ§å®ä¾‹
const apiMonitor = new APIMonitor();

// ä½¿ç”¨ç¤ºä¾‹
const result = await apiMonitor.trackAPICall('deepseek', async () => {
  return await callDeepSeek(prompt, stepName, requestId);
});
```

### æˆæœ¬ä¼˜åŒ–

**æç¤ºè¯ä¼˜åŒ–ç­–ç•¥**:
```javascript
class CostOptimizer {
  constructor() {
    this.tokenCosts = {
      'deepseek-chat': { input: 0.001, output: 0.002 },  // æ¯1K tokensä»·æ ¼
      'claude-3-sonnet': { input: 0.003, output: 0.015 },
      'jimeng_v4': 0.02  // æ¯å¼ å›¾ç‰‡ä»·æ ¼
    };
  }

  estimateTokens(text) {
    // ç®€å•çš„tokenä¼°ç®— (å®é™…åº”ä½¿ç”¨tokenizer)
    return Math.ceil(text.length / 3);
  }

  estimateCost(apiName, inputText, outputTokens = 1000) {
    const inputTokens = this.estimateTokens(inputText);
    const cost = this.tokenCosts[apiName];

    if (typeof cost === 'number') {
      return cost; // å›ºå®šä»·æ ¼ (å›¾ç‰‡ç”Ÿæˆ)
    }

    return (inputTokens / 1000 * cost.input) + (outputTokens / 1000 * cost.output);
  }

  optimizePrompt(prompt, maxTokens = 3000) {
    const currentTokens = this.estimateTokens(prompt);

    if (currentTokens <= maxTokens) {
      return prompt;
    }

    // ç®€å•æˆªæ–­ç­–ç•¥
    const ratio = maxTokens / currentTokens;
    const targetLength = Math.floor(prompt.length * ratio * 0.9); // é¢„ç•™10%ç¼“å†²

    return prompt.substring(0, targetLength) + '...';
  }
}

const costOptimizer = new CostOptimizer();

// ä½¿ç”¨ç¤ºä¾‹
const optimizedPrompt = costOptimizer.optimizePrompt(originalPrompt, 2500);
const estimatedCost = costOptimizer.estimateCost('deepseek-chat', optimizedPrompt);
console.log(`é¢„ä¼°æˆæœ¬: $${estimatedCost.toFixed(4)}`);
```

---

**æ–‡æ¡£ç‰ˆæœ¬**: v1.0.0
**æœ€åæ›´æ–°**: 2025-12-24
**ç»´æŠ¤è€…**: ScriptToFrame Team