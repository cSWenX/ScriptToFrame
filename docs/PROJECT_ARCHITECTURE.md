# ScriptToFrame 项目架构文档

## 项目概述

ScriptToFrame 是一个基于AI的漫剧分镜生成平台，能够自动将剧本转换为分镜图片。项目采用前后端分离架构，集成Claude和火山引擎即梦API，实现智能剧本解析和高质量图片生成。

## 系统架构图

```
┌─────────────────────────────────────────────────────────────────┐
│                        ScriptToFrame 系统架构                     │
└─────────────────────────────────────────────────────────────────┘

┌─────────────────┐    HTTP/API    ┌─────────────────┐    HTTP     ┌─────────────────┐
│                 │   ◄────────►   │                 │  ◄────────► │                 │
│   前端 (Next.js) │                │ Node.js API服务  │             │ Python后端服务   │
│                 │                │                 │             │   (FastAPI)     │
│  - React组件     │                │  - API路由      │             │                 │
│  - 状态管理      │                │  - 代理转发     │             │  - 火山引擎SDK   │
│  - 进度条显示    │                │  - Claude集成   │             │  - 图片生成API   │
│  - 用户交互      │                │  - 错误处理     │             │  - 结果处理     │
└─────────────────┘                └─────────────────┘             └─────────────────┘
         │                                   │
         │                                   │
         ▼                                   ▼
┌─────────────────┐                ┌─────────────────┐
│   浏览器存储     │                │   第三方API      │
│                 │                │                 │
│  - 本地状态     │                │  - Claude API   │
│  - Session存储  │                │  - DeepSeek API │
└─────────────────┘                │  - 火山引擎API   │
                                   └─────────────────┘
```

## 技术栈详解

### 前端技术栈
```
┌─────────────────┐
│   前端框架层     │
├─────────────────┤
│ Next.js 14.2.0  │  ← React全栈框架，支持SSR/SSG
│ React 18.3.1    │  ← UI组件库
│ TypeScript 5.0  │  ← 类型安全
└─────────────────┘

┌─────────────────┐
│    样式层       │
├─────────────────┤
│ Tailwind CSS    │  ← 原子化CSS框架
│ PostCSS         │  ← CSS后处理器
│ 自定义CSS变量   │  ← 未来科技风主题
└─────────────────┘

┌─────────────────┐
│    工具库       │
├─────────────────┤
│ Axios           │  ← HTTP请求库
│ dotenv          │  ← 环境变量管理
└─────────────────┘
```

### 后端技术栈
```
┌─────────────────┐
│  Node.js服务层   │
├─────────────────┤
│ Next.js API     │  ← API路由处理
│ @anthropic/sdk  │  ← Claude官方SDK
│ @volcengine/*   │  ← 火山引擎SDK
│ crypto          │  ← API签名生成
└─────────────────┘

┌─────────────────┐
│  Python服务层    │
├─────────────────┤
│ FastAPI 0.104.1 │  ← 现代Web框架
│ uvicorn 0.24.0  │  ← ASGI服务器
│ volcengine SDK  │  ← 官方Python SDK
│ python-dotenv   │  ← 环境变量
└─────────────────┘
```

## 服务架构设计

### 1. 前端架构 (Next.js)

```
src/
├── components/              # React组件
│   ├── ScriptInput.jsx     # 剧本输入组件
│   ├── ControlPanel.jsx    # 控制面板组件
│   ├── StoryboardDisplay.jsx # 分镜显示组件
│   └── ProgressBar.js      # 进度条组件
├── pages/                  # 路由页面
│   ├── index.js           # 主页面
│   └── api/               # API路由
│       ├── intelligent-analyze-script.js  # AI分析API
│       ├── generate-image-python.js       # 图片生成代理
│       └── generate-all-images.js         # 批量生成API
├── lib/                   # 工具库
│   ├── claude-api.js      # Claude API集成
│   ├── volcengine-api.js  # 火山引擎API集成
│   └── image-utils.js     # 图片处理工具
└── styles/               # 样式文件
```

### 2. Python后端架构 (FastAPI)

```
python-backend/
├── main.py               # FastAPI主入口
├── requirements.txt      # Python依赖
├── venv/                # 虚拟环境
└── logs/                # 日志目录
```

### 3. 服务通信架构

```
┌─────────────────┐
│   用户请求       │
└─────────────────┘
         │
         ▼
┌─────────────────┐
│  前端页面        │ ← 端口3000
│  (Next.js)      │
└─────────────────┘
         │
         ▼
┌─────────────────┐
│  Node.js API    │ ← API路由处理
│  (pages/api/)   │
└─────────────────┘
         │
         ├─── 剧本分析 ──► Claude API / DeepSeek API
         │
         └─── 图片生成 ──► Python后端 (:8081)
                            │
                            ▼
                    ┌─────────────────┐
                    │  火山引擎即梦API  │
                    │  (volcengine)   │
                    └─────────────────┘
```

## 数据流架构

### AI智能分析数据流
```
剧本文本输入
    │
    ▼
┌─────────────────┐
│  前端验证       │
└─────────────────┘
    │
    ▼
┌─────────────────┐
│  API: intelligent-analyze-script  │
└─────────────────┘
    │
    ▼ 4步工作流
┌─────────────────┐
│ Step1: 故事切分  │ ← DeepSeek API
└─────────────────┘
    │
    ▼
┌─────────────────┐
│ Step2: 关键帧提取│ ← DeepSeek API
└─────────────────┘
    │
    ▼
┌─────────────────┐
│ Step3: 提示词生成│ ← DeepSeek API
└─────────────────┘
    │
    ▼
┌─────────────────┐
│ Step4: 结果解析  │ ← 本地处理
└─────────────────┘
    │
    ▼
分镜帧数据结构
```

### 图片生成数据流
```
分镜提示词
    │
    ▼
┌─────────────────┐
│ API: generate-image-python  │
└─────────────────┘
    │
    ▼ HTTP代理
┌─────────────────┐
│ Python后端      │ ← 端口8081
│ (/api/generate-image)      │
└─────────────────┘
    │
    ▼ 官方SDK
┌─────────────────┐
│ 火山引擎即梦API  │
└─────────────────┘
    │
    ▼ 轮询结果
┌─────────────────┐
│ Base64/URL图片  │
└─────────────────┘
    │
    ▼
前端显示
```

## 关键技术决策

### 1. 为什么选择双后端架构？

**Node.js API服务**:
- 优势: 与Next.js无缝集成，处理路由和代理
- 负责: Claude API调用、请求转发、错误处理
- 特点: 轻量级，主要做API编排

**Python FastAPI服务**:
- 优势: 官方火山引擎SDK支持更完善
- 负责: 图片生成、SDK调用、结果处理
- 特点: 独立部署，专注图片生成

### 2. 为什么选择DeepSeek而非Claude做分析？

```javascript
// 配置灵活性
const apiConfig = {
  claude: {
    baseURL: process.env.ANTHROPIC_BASE_URL,  // 支持代理
    apiKey: process.env.ANTHROPIC_API_KEY
  },
  deepseek: {
    baseURL: process.env.DEEPSEEK_BASE_URL,   // 国内访问更稳定
    apiKey: process.env.DEEPSEEK_API_KEY
  }
}
```

### 3. 为什么使用即梦V4模型？

- 支持中文提示词
- 16:9比例输出适合分镜
- 生成质量高，适合漫剧风格
- 官方SDK支持完善

## 部署架构

### 开发环境
```
localhost:3000  ← Next.js前端 + API
localhost:8081  ← Python FastAPI后端
```

### 生产环境建议
```
┌─────────────────┐
│   Nginx反向代理  │ ← 端口80/443
└─────────────────┘
         │
    ┌────┴────┐
    │         │
    ▼         ▼
┌─────────┐ ┌─────────┐
│ Next.js │ │ Python  │
│  :3000  │ │  :8081  │
└─────────┘ └─────────┘
```

## 监控和日志

### 日志级别设计
```
console.log   ← 信息日志 (正常流程)
console.warn  ← 警告日志 (非致命错误)
console.error ← 错误日志 (需要关注)
```

### 关键监控指标
- API响应时间
- 图片生成成功率
- 错误率统计
- 内存使用情况

## 扩展性设计

### 水平扩展点
1. **API服务**: 可以启动多个Node.js实例
2. **图片生成**: 可以部署多个Python后端
3. **缓存层**: 可以加入Redis缓存生成结果
4. **队列系统**: 可以引入消息队列处理批量任务

### 插件化设计
- 支持多种AI模型切换
- 支持多种图片生成服务
- 支持自定义提示词模板

---

**文档版本**: v1.0.0
**最后更新**: 2025-12-24
**维护者**: ScriptToFrame Team